---
name: release-pypi

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  build-and-publish:
    name: Build and publish to PyPI
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.14"

      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry

      - name: Show versions
        run: |
          python --version
          poetry --version

      - name: Check tag vs pyproject.toml version
        run: |
          TAG_REF="${GITHUB_REF}"                 # e.g. refs/tags/v3.0.3
          TAG_VERSION="${TAG_REF#refs/tags/v}"    # -> 3.0.3

          POETRY_VERSION="$(poetry version -s)"   # read version from pyproject.toml

          echo "Tag version:     ${TAG_VERSION}"
          echo "Poetry version:  ${POETRY_VERSION}"

          if [ "${TAG_VERSION}" != "${POETRY_VERSION}" ]; then
            echo "::error::Tag version (v${TAG_VERSION}) does not match pyproject.toml version (${POETRY_VERSION})"
            exit 1
          fi

      - name: Configure Poetry PyPI token
        run: |
          poetry config pypi-token.pypi "${PYPI_API_TOKEN}"
        env:
          PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}

      - name: Build and publish to PyPI
        run: |
          poetry publish --build --no-interaction --verbose
